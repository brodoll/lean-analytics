!function(e,t){if("function"==typeof define&&define.amd)define(["exports","underscore","backbone","jquery","moment","crossfilter","dc.js","regression","unrolled-pie-chart","URI"],function(r,i,n,a,s,o,u,c,d){t(e,r,i,n,a,s,o,u,c,d.unrolledPieChart,URI)});else if("undefined"!=typeof exports){var r=require("underscore"),i=require("backbone"),n=require("jquery"),a=require("moment"),s=require("crossfilter").crossfilter,o=require("dc.js"),u=require("regression-js"),c=require("./unrolled-pie-chart.js").unrolledPieChart,d=require("uri.js");window.$=window.jQuery=n,require("bootstrap"),t(e,exports,r,i,n,a,s,o,u,c,d)}else e.LeanAnalytics=t(e,{},e._,e.Backbone,e.$,e.moment,e.crossfilter,e.dc,e.regression,e.dc.unrolledPieChart,e.URI)}(this,function(e,t,r,n,a,s,o,u,c,d,l){var h=function(){};return r.extend(h.prototype,n.Events),h.extend=n.Model.extend,t.Model=h.extend({constructor:function(){this.percentage=0,0!=arguments.length&&(this.percentage=100,initialize(arguments[0]),model.dataReady_=!0,model.trigger("changed:state"))},load:function(e){var t=this;d3.json(e).on("progress",function(){console.log("Progress "+d3.event.loaded+" of "+d3.event.total),t.percentage=d3.event.total?Math.floor(100*d3.event.loaded/d3.event.total):75,t.trigger("changed:state")}).on("load",function(e){t.percentage=100,t.trigger("changed:state"),t.initialize(e),t.dataReady_=!0,t.trigger("changed:state")}).on("error",function(e){t.error_=e,t.trigger("changed:state")}).get()},dataReady:function(){return this.dataReady_},loadedPercentage:function(){return this.percentage},error:function(){return this.error_},prepareData:function(e){return e.forEach(function(e){e.t=new Date(e.t)}),e},initialize:function(e){e=this.prepareData(e),this.data_=e,this.crf=o(e),this.timeDimension=this.crf.dimension(function(e){return e.t}),this.ranges_=this.makeRanges(),this.baseMetrics_=this.makeBaseMetrics(),this.derivedMetrics_=this.makeDerivedMetrics(),this.initializeData_(),this.range(this.ranges_[0].range),this.baseMetric(this.baseMetrics()[0]),this.derivedMetric(this.derivedMetrics()[0])},entryTime_:function(e){return e.t},timelineData:function(){return this.timelineData_},categoryData:function(){return this.categoryData_},tableData:function(){return this.tableData_},range:function(e){return arguments.length?(this.range_=e,this.timeDimension.filterRange(e),this):this.range_},ranges:function(){return this.ranges_},makeAllTimeRange:function(){var e=this.timeDimension.bottom(1)[0].t;return{name:"All time",range:[new Date(e),new Date]}},makeRanges:function(){return[this.makeAllTimeRange(),{name:"2 years",range:this.computeRange(2,"year")},{name:"1 year",range:this.computeRange(1,"year")}]},baseMetrics:function(){return this.baseMetrics_},baseMetric:function(e){function t(e,t){e.metricName=t.name,e.group.reduce(t.reduceAdd,t.reduceRemove,t.reduceInitial),e.valueAccessor=t.valueAccessor,e.group.order(function(e){return t.valueAccessor({value:e})})}if(!arguments.length)return this.baseMetric_;if(-1==this.baseMetrics_.indexOf(e))throw"Invalid base metric";if(this.baseMetric_!==e)return t(this.timelineData_[0],e),this.categoryData_.forEach(function(r){t(r,e)}),t(this.tableData_,e),this.baseMetric_=e,this.trigger("change:baseMetric",this),this},topEntries:function(e){var t=this.entriesByNameGroup.top(e),r=this.baseMetric_.valueAccessor;return t.filter(function(e){return Math.abs(r(e))>1e-5})},derivedMetric:function(e){if(!arguments.length)return this.derivedMetric_;if(-1==this.derivedMetrics_.indexOf(e))throw"Invalid derived metric";if(this.derivedMetric_!=e){var t=this.timelineData_[1];return t.metricName=e.name,t.group=e.group,t.valueAccessor=e.valueAccessor,this.derivedMetric_=e,this.trigger("change:derivedMetric",this),this}},derivedMetrics:function(){return this.derivedMetrics_},initializeData_:function(){var e=this.crf.dimension(function(e){return s(e.t).startOf("isoWeek").toDate()}),t=e.group();this.timelineData_=[{groupName:"week",dimension:e,group:t},{dimension:e}],this.categoryData_=this.makeCategoryGroups(),this.categoryData_.forEach(function(e){e.groupId||(e.groupId=e.groupName)}),this.tableData_=this.makeTableGroup()},makeCountMetric:function(e){function t(){return 0}function r(e){return e+=1}function i(e){return e-=1}return{name:e,reduceInitial:t,reduceAdd:r,reduceRemove:i,valueAccessor:function(e){return e.value}}},makeSumMetric:function(e,t){function r(){return 0}function i(e,r){return e+=t(r)}function n(e,r){return e-=t(r)}return{name:e,reduceInitial:r,reduceAdd:i,reduceRemove:n,valueAccessor:function(e){return e.value}}},makeBaseMetrics:function(){function e(){return{count:0,value:0}}function t(e,t){return e.count+=1,e.value+=t.value,e}function r(e,t){return e.count-=1,e.value-=t.value,e}return[{name:"Value",reduceAdd:t,reduceRemove:r,reduceInitial:e,valueAccessor:function(e){return e.value.value}},{name:"Count",reduceAdd:t,reduceRemove:r,reduceInitial:e,valueAccessor:function(e){return e.value.count}}]},makeDerivedMetricGroup_:function(e){var t=this;return{all:function(){var r=t.timelineData()[0],i=[];return r.group.all().forEach(function(e){e.key.getTime()>=t.range()[0].getTime()&&i.push([e.key,r.valueAccessor(e)])}),e(i).map(function(e){return{key:e[0],value:e[1]}})}}},makeLinearRegressionDerivedMetric:function(){var e=this.makeDerivedMetricGroup_(function(e){return e.forEach(function(e){e[0]=e[0].getTime()}),c("linear",e).points.map(function(e){return[new Date(e[0]),e[1]]})});return{name:"Linear regression",group:e}},makeCumulativeDerivedMetric:function(){var e=this.makeDerivedMetricGroup_(function(e){var t=0;return e.forEach(function(e){t+=e[1],e[1]=t}),e});return{name:"Cumulative",group:e}},makeAverageDerivedMetric:function(e){e=e||4;var t=this.makeDerivedMetricGroup_(function(t){for(i=t.length-1;i-e+1>=0;--i){var r,n=0;for(r=0;e>r;++r)n+=t[i-r][1];t[i][1]=n/e}return t});return{name:"Smoothed ("+e+"-week average)",group:t}},makeGaussianDerivedMetric:function(e){e=e||4;var t=this,i={all:function(){var i=t.timelineData()[0],n=[];i.group.all().forEach(function(e){e.key.getTime()>=t.range()[0].getTime()&&n.push([e.key.getTime(),i.valueAccessor(e)])});var a=function(e,t){var i=2*t-1;weight=r.range(0,i).map(function(){return 1}),weightGauss=[];for(o in r.range(0,i))o=o-t+1,frac=o/i,gauss=1/Math.exp(4*frac*4*frac),weightGauss.push(gauss);for(weight=r(weightGauss).zip(weight).map(function(e){return e[0]*e[1]}),smoothed=r.range(0,e.length+1-i).map(function(){return 0}),o=0;o<smoothed.length;o++)smoothed[o]=r(e.slice(o,o+i)).zip(weight).map(function(e){return e[0]*e[1]}).reduce(function(e,t){return e+t},0)/r(weight).reduce(function(e,t){return e+t},0);return smoothed},s=n.map(function(e){return e[1]});s=a(s,e);var o,u=[];for(o=0;o<s.length;++o)u.push({key:new Date(n[o+e-1][0]),value:s[o]});return u}},n=2*e-1;return{name:"Smoothed ("+n+"-week gaussian)",group:i}},makeDerivedMetrics:function(){return[this.makeLinearRegressionDerivedMetric(),this.makeCumulativeDerivedMetric(),this.makeAverageDerivedMetric(),this.makeGaussianDerivedMetric()]},makePerDayOfWeekGroup:function(){var e=this.crf.dimension(function(e){return s(e.t).isoWeekday()}),t=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];return{groupId:"day",groupName:"Day of week",dimension:e,group:e.group(),keyFormatter:function(e){return t[e-1]}}},makePerHourGroup:function(){var e=this.crf.dimension(function(e){var t=e.t.getHours();return 6>t?"Night":12>t?"Morning":18>t?"Afternoon":23>t?"Evening":void 0});return{groupId:"hour",groupName:"Time of day",dimension:e,group:e.group()}},makeCategoryGroups:function(){return[this.makePerDayOfWeekGroup(),this.makePerHourGroup()]},makeTableGroup:function(){var e=this.crf.dimension(function(e){return e.name});return{groupName:"Name",dimension:e,group:e.group()}},computeRange:function(e,t){var r=["day","week","month","year"];if(-1==r.indexOf(t))throw"Invalid date unit '+ "+t+"'. Valid values are: "+r;var i=s();"day"!==t&&i.endOf("isoWeek");var n=s(i);return n.subtract(e,t),[n.toDate(),i.toDate()]}}),t.View=h.extend({constructor:function(e,t,i){if(this.model=t,this.$element="string"==typeof e?a(e):e,this.$element.addClass("la"),this.options=i||{},r.defaults(this.options,{marginLeft:40}),!this.options.template){var n="lean-analytics.html",s=a('script[src*="lean-analytics"]');if(1==s.length){var o=s.attr("src"),u=o.lastIndexOf("/");-1!=u&&(n=o.substring(0,u+1)+n)}this.options.template=n}this.timelineCharts=[],this.categoryCharts=[],t.on("changed:state",this.update,this),this.update()},update:function(){var e=this;if(this.model.dataReady())return void(this.graphsCreated_||(this.graphsCreated_=!0,this.$element.load(this.options.template,function(){e.makeGraphs_(e.model),e.options.storeState&&e.restoreState(),u.renderAll()})));var t=this.model.error();if(t)t instanceof XMLHttpRequest&&(t=t.statusText),void 0==this.$errorMessage&&(this.$errorMessage=a("                        <div class='error'><p class='bg-danger'><b>Could not load data</b>: <span></span></p></div>                        "),this.$element.append(this.$errorMessage)),this.$errorMessage.find("span").text(t),this.$progress&&this.$progress.hide();else{void 0==this.$progress&&(this.$progress=a("                    <div class='progress'>                        <div>Loading data</div>                        <div class='progress-bar-background'>                            <div class='progress-bar' role='progressbar' aria-valuenow='60' aria-valuemin='0' aria-valuemax='100'>                            </div>                        </div>                    </div>"),this.$element.append(this.$progress)),this.$error&&this.$error.hide(),this.$progress.show();var r=this.$progress.find(".progress-bar");r.css("width",this.model.loadedPercentage()+"%")}},initializeDropdown:function(e,t,r,i,n){n=n||function(e){return e.name};var s=e.find("button"),o=e.find("ul.dropdown-menu");s.find("span:first").text(n(r)),t.forEach(function(e){var t=a("<li><a href='#'>"+n(e)+"</a></li>");o.append(t),t.find("a").click(function(){i(e),s.find("span:first").text(n(e))})})},defaultValueFormatter:function(e){function t(e){var t,r="",i=e.length;for(t=0;i>t;++t){var n=i-t;0!=t&&n%3==0&&(r+=" "),r+=e[t]}return r}return"number"==typeof e?t(Math.round(e).toString()):e},updateChart:function(e,t,r){var i;i=t.groupName&&t.metricName?t.metricName+" by "+t.groupName:t.metricName,i=this.capitalize(i),e.dimension(t.dimension).group(t.group,i);var n=t.keyFormatter||r||function(e){return e},a=t.valueAccessor||function(e){return e.value},s=t.valueFormatter||this.defaultValueFormatter;e.valueAccessor(a),e.title(function(e){return n(e.key)+": "+s(a(e))}),e.label(function(e){return n(e.key)})},dateFormatter:d3.time.format("%Y-%m-%d"),updateCharts:function(){var e,t=this.model.timelineData();if(t.length!=this.timelineCharts.length)throw"Different number of timeline charts in model and view";for(e=0;e<t.length;++e)this.updateChart(this.timelineCharts[e],t[e],this.dateFormatter);var r=this.model.categoryData();if(r.length!=this.categoryCharts.length)throw"Different number of category charts in model and view";for(e=0;e<r.length;++e){var i=r[e],n=this.categoryCharts[e];this.updateChart(n,i);var a=n.$container;a.find("span.secondary-chart-title").text(i.groupName),a.find("span.secondary-chart-subtitle").text(this.capitalize("Total "+i.metricName+" by "+i.groupName))}},makeGraphs_:function(e){function t(e){c.text(s(e[0]).format("MMM D YYYY")+" to "+s(e[1]).format("MMM D YYYY"))}var r,i,n=this.mainChart=u.compositeChart(this.$element.find("#primary")[0]),o=this.$element.find("#range-selector"),c=this.$element.find(".range-display");t(e.range()),e.ranges().forEach(function(r){var i=r.name,s=r.range,c=e.range()==s,d=a("<label class='btn btn-default'></label>");c&&d.addClass("active"),d.text(i);var l=a("<input type='radio'>");c&&l.prop("checked",!0),l.change(function(){l.is(":checked")&&(e.range(s),n.x().domain(s),t(s),u.renderAll())}),d.append(l),o.append(d)}),n.width(1140).height(400).dimension(e.valueByTimeUnit).margins({top:10,right:0,bottom:30,left:this.options.marginLeft}).x(d3.time.scale().domain(e.range()).nice(d3.time.day)).xUnits(d3.time.weeks).elasticY(!0).legend(u.legend().x(80).y(20).itemHeight(13).gap(5)).renderHorizontalGridLines(!0).compose([r=u.barChart(n).dimension(e.valueByTimeUnit).colors("steelblue").centerBar(!0),i=u.lineChart(n).dimension(e.valueByTimeUnit).colors("red")]).brushOn(!1),this.timelineCharts.push(r,i),n.xAxis().tickFormat(d3.time.format("%Y-%m-%d"));var l=this.$element.find("#base-metric-selector");e.baseMetrics().length<2?l.hide():this.initializeDropdown(l,e.baseMetrics(),e.baseMetric(),function(t){e.baseMetric(t)});var h=this.$element.find("#derived-metric-selector");e.derivedMetrics().length<2&&this.$element.find("#derived-metric-selector").hide(),this.initializeDropdown(h,e.derivedMetrics(),e.derivedMetric(),function(t){e.derivedMetric(t)}),e.categoryData().forEach(function(){var e,t,r=a(this.$element.find("#secondary")[0]),i=!0;if(i){var e=a("<div class='col-lg-12'><span class='secondary-chart-title'></span> <span class='secondary-chart-subtitle'></span>  <a class='reset pull-right' style='display: none;'>Clear filters</a></div></div>");r.append(e),t=d(e[0]),t.$container=e,t.cap(10),t.elasticX(!0).width(1140).height(35).fixedBarHeight(20).margins({top:10,right:0,bottom:30,left:this.options.marginLeft}),e.find("a").click(function(){t.filterAll(),u.redrawAll()})}else{var e=a("<div class='col-lg-4'><span class='secondary-chart-title'></span> <span class='secondary-chart-subtitle'></span><div style='height: 200px'></div></div>");r.append(e),t=u.rowChart(e.children("div")[0]),t.$container=e,t.elasticX(!0).width(250).height(200).margins({top:10,right:10,bottom:30,left:this.options.marginLeft})}this.options.storeState&&this.setFilteredHandler(t),this.categoryCharts.push(t)}.bind(this));var f=this;u.registerChart({render:function(){this.redraw()},redraw:function(){f.updateTable()}}),this.updateCharts(),this.listenTo(this.model,"change:baseMetric change:derivedMetric",function(){this.updateCharts(),u.renderAll()})},setFilteredHandler:function(e){var t=this;e.on("filtered",function(e){if(!t.blockFilterEvents){var r=t.categoryCharts.indexOf(e);if(-1!=r){var i=t.model.categoryData()[r].groupId,n=null,a=e.filters();a&&a.length>0&&(n=a.join("-")),t.setViewStateKey(i,n)}}})},setViewStateKey:function(e,t){var r=l(window.location.href),i=r.search(!0);t?i[e]=t:delete i[e],r.search(i),window.history?window.history.pushState({},"",r.resource()):window.location.search=r.toString()},updateTable:function(){var e=this.model.tableData(),t=e.group.top(40),r=e.valueAccessor;t=t.filter(function(e){return Math.abs(r(e))>1e-5});var i=this.$element.find("#table")[0],n=a(i);n.find("span.table-title").text(e.groupName),n.find("span.table-subtitle").text(this.capitalize("Total "+e.metricName+" by "+e.groupName));var s=d3.select(i);s.select("table").style("margin-left",this.options.marginLeft+"px");var o=s.select("tbody"),u=o.selectAll("tr").data(t),c=u.enter().append("tr");c.append("td"),c.append("td"),u.classed("gain",function(e){return e.value>0});var d,l=this.model.baseMetric().valueAccessor,h=this.model.baseMetric().valueFormatter||this.defaultValueFormatter,d=u.selectAll("td").data(function(e){return[h(l(e)),e.key]});d.text(function(e){return e}),u.exit().remove()},restoreState:function(){var e=this,t=l(window.location.href),r=t.search(!0);e.blockFilterEvents=!0,model.categoryData().forEach(function(t,i){var n=t.groupId,a=r[n];if(a){"/"==a[a.length-1]&&(a=a.substr(0,a.length-1));var s=a.split("-");t.dimension.filter(s),s.forEach(function(t){e.categoryCharts[i].filter(t)})}}),e.blockFilterEvents=!1},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}}),t});