!function(e,t){if("function"==typeof define&&define.amd)define(["exports","underscore","backbone","jquery","moment","crossfilter","dc.js","regression","unrolled-pie-chart"],function(r,i,n,a,s,o,u,c,d){t(e,r,i,n,a,s,o,u,c,d.unrolledPieChart)});else if("undefined"!=typeof exports){var r=require("underscore"),i=require("backbone"),n=require("jquery"),a=require("moment"),s=require("crossfilter").crossfilter,o=require("dc.js"),u=require("regression-js"),c=require("./unrolled-pie-chart.js").unrolledPieChart;window.$=window.jQuery=n,require("bootstrap"),t(e,exports,r,i,n,a,s,o,u,c)}else e.LeanAnalytics=t(e,{},e._,e.Backbone,e.$,e.moment,e.crossfilter,e.dc,e.regression,e.dc.unrolledPieChart)}(this,function(e,t,r,n,a,s,o,u,c,d){var h=function(){};return r.extend(h.prototype,n.Events),h.extend=n.Model.extend,t.Model=h.extend({constructor:function(){this.percentage=0,0!=arguments.length&&(this.percentage=100,initialize(arguments[0]),model.dataReady_=!0,model.trigger("changed:state"))},load:function(e){var t=this;d3.json(e).on("progress",function(){console.log("Progress "+d3.event.loaded+" of "+d3.event.total),t.percentage=d3.event.total?Math.floor(100*d3.event.loaded/d3.event.total):75,t.trigger("changed:state")}).on("load",function(e){t.percentage=100,t.trigger("changed:state"),t.initialize(e),t.dataReady_=!0,t.trigger("changed:state")}).on("error",function(e){t.errorMessage=e}).get()},dataReady:function(){return this.dataReady_},loadedPercentage:function(){return this.percentage},prepareData:function(e){e.forEach(function(e){e.t=new Date(e.t)})},initialize:function(e){this.prepareData(e),this.data_=e,this.crf=o(e),this.timeDimension=this.crf.dimension(function(e){return e.t}),this.entriesByName=this.crf.dimension(function(e){return e.name}),this.entriesByNameGroup=this.entriesByName.group(),this.ranges_=this.makeRanges_(),this.initializeData_(),this.metrics_=this.makeMainMetrics_(),this.derivedMetrics_=this.makeDerivedMetrics_(),this.range(this.ranges_[1].range),this.mainMetric(this.mainMetrics()[0]),this.derivedMetric(this.derivedMetrics()[0])},entryTime_:function(e){return e.t},graphData:function(){return this.graphData_},range:function(e){return arguments.length?(this.range_=e,this.timeDimension.filterRange(e),this):this.range_},ranges:function(){return this.ranges_},makeRanges_:function(){var e=this.timeDimension.bottom(1)[0].t;return[{name:"All time",range:[e,new Date]},{name:"2 years",range:this.computeRange(2,"year")},{name:"1 year",range:this.computeRange(1,"year")}]},mainMetrics:function(){return this.metrics_},mainMetric:function(e){if(!arguments.length)return this.mainMetric_;if(-1==this.metrics_.indexOf(e))throw"Invalid main metric";if(this.mainMetric_!==e)return this.entriesByNameGroup.reduce(e.reduceAdd,e.reduceRemove,e.reduceInitial),this.entriesByNameGroup.order(function(t){return e.valueAccessor({value:t})}),this.graphData_.forEach(function(t){t[0].metricName=e.name,t[0].group.reduce(e.reduceAdd,e.reduceRemove,e.reduceInitial),t[0].valueAccessor=e.valueAccessor,t[0].group.order(function(t){return e.valueAccessor({value:t})})}),this.mainMetric_=e,this.trigger("change:mainMetric",this),this},topEntries:function(e){var t=this.entriesByNameGroup.top(e),r=this.mainMetric_.valueAccessor;return t.filter(function(e){return Math.abs(r(e))>1e-5})},derivedMetric:function(e){if(!arguments.length)return this.derivedMetric_;if(-1==this.derivedMetrics_.indexOf(e))throw"Invalid derived metric";if(this.derivedMetric_!=e){var t=this.graphData_[0][1];return t.metricName=e.name,t.group=e.group,t.valueAccessor=e.valueAccessor,this.derivedMetric_=e,this.trigger("change:derivedMetric",this),this}},derivedMetrics:function(){return this.derivedMetrics_},initializeData_:function(){var e=[[null,null]],t=this.crf.dimension(function(e){return s(e.t).startOf("isoWeek").toDate()}),r=t.group();e[0][0]={groupName:"week",dimension:t,group:r},e[0][1]={dimension:t},this.makeAdditionalGroups_().forEach(function(t){e.push([t])}),this.graphData_=e},makeMainMetrics_:function(){function e(){return{count:0,value:0}}function t(e,t){return e.count+=1,e.value+=t.value,e}function r(e,t){return e.count-=1,e.value-=t.value,e}return[{name:"Value",reduceAdd:t,reduceRemove:r,reduceInitial:e,valueAccessor:function(e){return e.value.value}},{name:"Count",reduceAdd:t,reduceRemove:r,reduceInitial:e,valueAccessor:function(e){return e.value.count}}]},makeDerivedMetricGroup_:function(e){var t=this;return{all:function(){var r=t.graphData()[0][0],i=[];return r.group.all().forEach(function(e){e.key.getTime()>=t.range()[0].getTime()&&i.push([e.key,r.valueAccessor(e)])}),e(i).map(function(e){return{key:e[0],value:e[1]}})}}},makeDerivedMetrics_:function(){var e=this,t=this.makeDerivedMetricGroup_(function(e){return e.forEach(function(e){e[0]=e[0].getTime()}),c("linear",e).points.map(function(e){return[new Date(e[0]),e[1]]})}),n=this.makeDerivedMetricGroup_(function(e){var t=0;return e.forEach(function(e){t+=e[1],e[1]=t}),e}),a=this.makeDerivedMetricGroup_(function(e){var t=4;for(i=e.length-1;i-t+1>=0;--i){var r,n=0;for(r=0;t>r;++r)n+=e[i-r][1];e[i][1]=n/t}return e}),s={all:function(){var t=e.graphData()[0][0],i=[];t.group.all().forEach(function(r){r.key.getTime()>=e.range()[0].getTime()&&i.push([r.key.getTime(),t.valueAccessor(r)])});var n=function(e,t){var i=2*t-1;weight=r.range(0,i).map(function(){return 1}),weightGauss=[];for(s in r.range(0,i))s=s-t+1,frac=s/i,gauss=1/Math.exp(4*frac*4*frac),weightGauss.push(gauss);for(weight=r(weightGauss).zip(weight).map(function(e){return e[0]*e[1]}),smoothed=r.range(0,e.length+1-i).map(function(){return 0}),s=0;s<smoothed.length;s++)smoothed[s]=r(e.slice(s,s+i)).zip(weight).map(function(e){return e[0]*e[1]}).reduce(function(e,t){return e+t},0)/r(weight).reduce(function(e,t){return e+t},0);return smoothed},a=i.map(function(e){return e[1]});a=n(a,4);var s,o=[];for(s=0;s<a.length;++s)o.push({key:i[s+5][0],value:a[s]});return o}};return[{name:"Linear regression",group:t},{name:"Cumulative",group:n},{name:"Smooth - 4-week average",group:a},{name:"Smooth - 7-week gaussian",group:s}]},makePerDayOfWeekGroup_:function(){var e=this.crf.dimension(function(e){return s(e.t).isoWeekday()}),t=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];return{groupName:"Day of week",dimension:e,group:e.group(),keyFormatter:function(e){return t[e-1]}}},makePerHourGroup_:function(){var e=this.crf.dimension(function(e){var t=e.t.getHours();return 6>t?"Night":12>t?"Morning":18>t?"Afternoon":23>t?"Evening":void 0});return{groupName:"Time of day",dimension:e,group:e.group()}},makeAdditionalGroups_:function(){return[this.makePerDayOfWeekGroup_(),this.makePerHourGroup_()]},computeRange:function(e,t){var r=["day","week","month","year"];if(-1==r.indexOf(t))throw"Invalid date unit '+ "+t+"'. Valid values are: "+r;var i=s();"day"!==t&&i.endOf("isoWeek");var n=s(i);return n.subtract(e,t),[n.toDate(),i.toDate()]}}),t.View=h.extend({constructor:function(e,t,i){this.model=t,this.$element="string"==typeof e?a(e):e,this.$element.addClass("la"),this.options=i||{},r.defaults(this.options,{template:"lean-analytics.html",marginLeft:40}),this.charts=[],t.on("changed:state",this.update,this),this.update()},update:function(){if(this.model.dataReady()){if(!this.graphsCreated_){this.graphsCreated_=!0;var e=this;this.$element.load(this.options.template,function(){e.makeGraphs_(e.model)})}}else{if(void 0==this.$progress){var t=a("                <div class='progress'>                    <div>Loading data</div>                    <div class='progress-bar-background'>                        <div class='progress-bar' role='progressbar' aria-valuenow='60' aria-valuemin='0' aria-valuemax='100'>                        </div>                    </div>                </div>");this.$element.append(t),this.$progress=t.find(".progress-bar")}this.$progress.css("width",this.model.loadedPercentage()+"%")}},initializeDropdown:function(e,t,r,i,n){n=n||function(e){return e.name};var s=e.find("button"),o=e.find("ul.dropdown-menu");s.find("span:first").text(n(r)),t.forEach(function(e){var t=a("<li><a href='#'>"+n(e)+"</a></li>");o.append(t),t.find("a").click(function(){i(e),s.find("span:first").text(n(e))})})},defaultValueFormatter:function(e){function t(e){var t,r="",i=e.length;for(t=0;i>t;++t){var n=i-t;0!=t&&n%3==0&&(r+=" "),r+=e[t]}return r}return"number"==typeof e?t(Math.round(e).toString()):e},updateChart:function(e,t,r){var i;i=t.groupName&&t.metricName?t.metricName+" by "+t.groupName:t.metricName,i=this.capitalize(i),e.dimension(t.dimension).group(t.group,i);var n=t.keyFormatter||r||function(e){return e},a=t.valueAccessor||function(e){return e.value},s=t.valueFormatter||this.defaultValueFormatter;e.valueAccessor(a),e.title(function(e){return n(e.key)+": "+s(a(e))}),e.label(function(e){return n(e.key)})},dateFormatter:d3.time.format("%Y-%m-%d"),updateCharts:function(){var e=this.model.graphData();if(e.length!=this.charts.length)throw"Different number of charts in model and view";this.updateChart(this.charts[0][0],e[0][0],this.dateFormatter),this.updateChart(this.charts[0][1],e[0][1],this.dateFormatter);var t;for(t=1;t<e.length;++t){var r=e[t][0];this.updateChart(this.charts[t][0],r);var i=this.charts[t][0].$container;i.find("span.secondary-chart-title").text(r.groupName),i.find("span.secondary-chart-subtitle").text(this.capitalize("Total "+r.metricName+" by "+r.groupName))}},makeGraphs_:function(e){function t(e){c.text(s(e[0]).format("MMM D YYYY")+" to "+s(e[1]).format("MMM D YYYY"))}var r,i,n=this.mainChart=u.compositeChart(this.$element.find("#primary")[0]),o=this.$element.find("#range-selector"),c=this.$element.find(".range-display");t(e.range()),e.ranges().forEach(function(r){var i=r.name,s=r.range,c=e.range()==s,d=a("<label class='btn btn-default'></label>");c&&d.addClass("active"),d.text(i);var h=a("<input type='radio'>");c&&h.prop("checked",!0),h.change(function(){h.is(":checked")&&(e.range(s),n.x().domain(s),t(s),u.renderAll())}),d.append(h),o.append(d)}),n.width(1140).height(400).dimension(e.valueByTimeUnit).margins({top:10,right:10,bottom:30,left:this.options.marginLeft}).x(d3.time.scale().domain(e.range()).nice(d3.time.day)).xUnits(d3.time.weeks).elasticY(!0).legend(u.legend().x(80).y(20).itemHeight(13).gap(5)).renderHorizontalGridLines(!0).compose([r=u.barChart(n).dimension(e.valueByTimeUnit).colors("steelblue").centerBar(!0),i=u.lineChart(n).dimension(e.valueByTimeUnit).colors("red")]).brushOn(!1),this.charts.push([r,i]),n.xAxis().tickFormat(d3.time.format("%Y-%m-%d")),this.initializeDropdown(this.$element.find("#main-metric-selector"),e.mainMetrics(),e.mainMetric(),function(t){e.mainMetric(t)}),this.initializeDropdown(this.$element.find("#derived-metric-selector"),e.derivedMetrics(),e.derivedMetric(),function(t){e.derivedMetric(t)}),e.graphData().slice(1).forEach(function(e){e=e[0];var t,r,i=a(this.$element.find("#secondary")[0]),n=!0;if(n){var t=a("<div class='col-lg-12'><span class='secondary-chart-title'></span> <span class='secondary-chart-subtitle'></span><div style='height: 70px'></div></div>");i.append(t),r=d(t.children("div")[0]),r.$container=t,r.cap(10),r.elasticX(!0).width(1140).height(65).margins({top:10,right:10,bottom:30,left:this.options.marginLeft})}else{var t=a("<div class='col-lg-4'><span class='secondary-chart-title'></span> <span class='secondary-chart-subtitle'></span><div style='height: 200px'></div></div>");i.append(t),r=u.rowChart(t.children("div")[0]),r.$container=t,r.elasticX(!0).width(250).height(200).margins({top:10,right:10,bottom:30,left:this.options.marginLeft})}this.charts.push([r])}.bind(this));var h=this;u.registerChart({render:function(){this.redraw()},redraw:function(){h.updateTable()}}),this.updateCharts(),this.listenTo(this.model,"change:mainMetric change:derivedMetric",function(){this.updateCharts(),u.renderAll()}),u.renderAll()},updateSecondaryChartTitle:function(){},updateTable:function(){var e=this.model.topEntries(40),t=d3.select(this.$element.find("#table")[0]),r=t.select("thead");r.select("th").text(this.model.mainMetric().name);var i=t.select("tbody"),n=i.selectAll("tr").data(e),a=n.enter().append("tr");a.append("td"),a.append("td"),n.classed("gain",function(e){return e.value>0});var s,o=this.model.mainMetric().valueAccessor,u=this.model.mainMetric().valueFormatter||this.defaultValueFormatter,s=n.selectAll("td").data(function(e){return[u(o(e)),e.key]});s.text(function(e){return e}),n.exit().remove()},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}}),t});